{% extends "mainapp/base.html" %}

{% block title %}Last opp sensor-data{% endblock %}

{% block content %}
  <div class="max-w-5xl mx-auto p-6 shadow-md rounded-lg space-y-6" style="background-color: #e8ece4;">
    <h2 class="text-2xl font-semibold text-gray-800">Last opp sensor-data (JSON)</h2>

    {% if messages %}
      <div>
        {% for message in messages %}
          <p class="text-sm text-{{ message.tags }}">{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="space-y-4">
      {% csrf_token %}
      <label for="files" class="block text-sm font-medium text-gray-700">Velg JSON-filer:</label>
      <input type="file" name="files" id="files" multiple class="block w-full">
      <button type="submit" class="text-white px-4 py-2 rounded transition" style="background-color: #408424;">Last opp</button>
    </form>

    <form method="get" class="space-y-4">
      <label for="sensor" class="block text-sm font-medium text-gray-700">Velg sensor:</label>
      <select name="sensor" id="sensor" class="w-full border border-gray-300 rounded p-2">
        {% for sensor in sensors %}
          <option value="{{ sensor.sensor_id }}" {% if request.GET.sensor == sensor.sensor_id %}selected{% endif %}>
            {{ sensor.sensor_id }}
          </option>
        {% endfor %}
      </select>

      <div class="flex space-x-4">
        <div class="w-1/2">
          <label for="start_date" class="block text-sm font-medium text-gray-700">Startdato:</label>
          <input type="date" name="start_date" id="start_date"
                 value="{{ request.GET.start_date|default:default_start }}"
                 class="w-full border border-gray-300 rounded p-2">
        </div>
        <div class="w-1/2">
          <label for="end_date" class="block text-sm font-medium text-gray-700">Sluttdato:</label>
          <input type="date" name="end_date" id="end_date"
                 value="{{ request.GET.end_date|default:default_end }}"
                 class="w-full border border-gray-300 rounded p-2">
        </div>
      </div>

      <button type="submit" class="w-full text-white py-2 px-4 rounded transition" style="background-color: #408424;">
        Vis data
      </button>
    </form>

    {% if latest_readings %}
      <div>
        <p class="text-lg font-semibold">Siste batterinivå: <span class="text-blue-700">{{ latest_readings.battery }} V</span></p>
      </div>
    {% endif %}

    {% if chart_data %}
      <div class="space-y-6 mt-6">
        <div class="w-full h-[400px]"><canvas id="tempChart"></canvas></div>
        <div class="w-full h-[400px]"><canvas id="humidityChart"></canvas></div>
      </div>
    {% endif %}
  </div>

  {% if chart_data %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const chartData = {{ chart_data|safe }};
      const timestamps = chartData.map(d => d.timestamp);
      const airTemp = chartData.map(d => d.air_temperature);
      const soilTemp = chartData.map(d => d.soil_temperature);
      const airHumidity = chartData.map(d => d.air_humidity);
      const soilMoisture = chartData.map(d => d.soil_moisture);

      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: {
              maxTicksLimit: 15,
              maxRotation: 45,
              minRotation: 45
            }
          }
        },
        plugins: {
          legend: { position: 'bottom' }
        }
      };

      new Chart(document.getElementById('tempChart'), {
        type: 'line',
        data: {
          labels: timestamps,
          datasets: [
            {
              label: 'Lufttemperatur (°C)',
              data: airTemp,
              borderWidth: 2,
              fill: false
            },
            {
              label: 'Jordtemperatur (°C)',
              data: soilTemp,
              borderWidth: 2,
              fill: false
            }
          ]
        },
        options: commonOptions
      });

      new Chart(document.getElementById('humidityChart'), {
        type: 'line',
        data: {
          labels: timestamps,
          datasets: [
            {
              label: 'Luftfuktighet (%)',
              data: airHumidity,
              borderWidth: 2,
              fill: false
            },
            {
              label: 'Jordfuktighet (%)',
              data: soilMoisture,
              borderWidth: 2,
              fill: false
            }
          ]
        },
        options: commonOptions
      });
    </script>
  {% endif %}
{% endblock %}