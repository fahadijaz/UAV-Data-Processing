{% extends "mainapp/base.html" %}

{% block title %}Last opp sensor-data{% endblock %}

{% block content %}
  <div class="max-w-5xl mx-auto p-6 shadow-md rounded-lg space-y-6" style="background-color: #e8ece4;">
    <h2 class="text-2xl font-semibold text-gray-800">Last opp sensor-data (JSON)</h2>

    {% if messages %}
      <div>
        {% for message in messages %}
          <p class="text-sm text-{{ message.tags }}">{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="space-y-4">
      {% csrf_token %}
      <label for="files" class="block text-sm font-medium text-gray-700">Velg JSON-filer:</label>
      <input type="file" name="files" id="files" multiple class="block w-full">
      <button type="submit" class="text-white px-4 py-2 rounded transition" style="background-color: #408424;">Last opp</button>
    </form>

    <form method="get" class="space-y-4">
      <label for="sensor" class="block text-sm font-medium text-gray-700">Velg sensor:</label>
      <select name="sensor" id="sensor" class="w-full border border-gray-300 rounded p-2">
        {% for sensor in sensors %}
          <option value="{{ sensor.sensor_id }}" {% if request.GET.sensor == sensor.sensor_id %}selected{% endif %}>
            {{ sensor.sensor_id }}
          </option>
        {% endfor %}
      </select>

      <div class="flex space-x-4">
        <div class="w-1/2">
          <label for="start_date" class="block text-sm font-medium text-gray-700">Startdato:</label>
          <input type="date" name="start_date" id="start_date"
                 value="{{ request.GET.start_date|default:default_start }}"
                 class="w-full border border-gray-300 rounded p-2">
        </div>
        <div class="w-1/2">
          <label for="end_date" class="block text-sm font-medium text-gray-700">Sluttdato:</label>
          <input type="date" name="end_date" id="end_date"
                 value="{{ request.GET.end_date|default:default_end }}"
                 class="w-full border border-gray-300 rounded p-2">
        </div>
      </div>

      <button type="submit" class="w-full text-white py-2 px-4 rounded transition" style="background-color: #408424;">
        Vis data
      </button>
    </form>

    {% if latest_readings %}
      <div>
        <p class="text-lg font-semibold">Siste batterinivå: <span class="text-blue-700">{{ latest_readings.battery }} V</span></p>
      </div>
    {% endif %}

    {% if chart_data %}
      <div class="space-y-6 mt-6">
        <div class="w-full h-[400px]"><canvas id="tempChart"></canvas></div>
        <div class="w-full h-[400px]"><canvas id="humidityChart"></canvas></div>
      </div>
    {% endif %}
  </div>

{% if chart_data %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script>
    // Rådata fra view
    const raw = {{ chart_data|safe }};
    const periodStart = new Date("{{ default_start }}T00:00:00");
    const periodEnd   = new Date("{{ default_end }}T23:59:59");

    // 1) Grupper målinger per dag (YYYY-MM-DD)
    const byDay = new Map();
    for (const r of raw) {
      // r.timestamp er f.eks. "2025-09-07 13:45" -> bruk dato-delen
      const dayKey = r.timestamp.slice(0, 10); // "YYYY-MM-DD"
      if (!byDay.has(dayKey)) byDay.set(dayKey, []);
      byDay.get(dayKey).push(r);
    }

    // Velg hvordan du aggregerer flere målinger per dag:
    function aggregateDay(rows) {
      // eksempel: ta siste måling den dagen
      const last = rows[rows.length - 1];
      return {
        air_temperature: last.air_temperature ?? null,
        soil_temperature: last.soil_temperature ?? null,
        air_humidity: last.air_humidity ?? null,
        soil_moisture: last.soil_moisture ?? null,
      };
      // Alternativ: snitt
      // const avg = (arr, k) => arr.map(x => +x[k]).filter(n=>Number.isFinite(n)).reduce((a,b)=>a+b,0) / arr.length || null;
      // return { air_temperature: avg(rows,'air_temperature'), ... }
    }

    // 2) Lag tett serie: én rad per dag i valgt periode; null der vi mangler data
    function eachDay(start, end) {
      const out = [];
      const d = new Date(start);
      d.setHours(0,0,0,0);
      const last = new Date(end);
      last.setHours(0,0,0,0);
      while (d <= last) {
        out.push(new Date(d));
        d.setDate(d.getDate() + 1);
      }
      return out;
    }

    const dense = eachDay(periodStart, periodEnd).map(d => {
      const key = d.toISOString().slice(0, 10); // YYYY-MM-DD
      const agg = byDay.has(key) ? aggregateDay(byDay.get(key)) : null;
      return {
        timestamp: key, // Chart.js adapter skjønner ISO-dato
        air_temperature: agg ? agg.air_temperature : null,
        soil_temperature: agg ? agg.soil_temperature : null,
        air_humidity: agg ? agg.air_humidity : null,
        soil_moisture: agg ? agg.soil_moisture : null,
      };
    });

    // Felles visningsvalg
    const xScaleTime = {
      type: 'time',
      time: {
        unit: 'day', // bytt til 'week' om du vil
        tooltipFormat: 'dd.MM.yyyy',
        displayFormats: { day: 'dd.MM', week: 'dd.MM' }
      },
      min: "{{ default_start }}", // vis alltid hele valgt periode
      max: "{{ default_end }}"
    };

    const commonPlugins = {
      legend: { position: 'bottom' },
      tooltip: { mode: 'index', intersect: false }
    };

    // 3) Temperatur (hull i data via null-verdier)
    new Chart(document.getElementById('tempChart'), {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'Lufttemperatur (°C)',
            data: dense,
            parsing: { xAxisKey: 'timestamp', yAxisKey: 'air_temperature' },
            spanGaps: false, // <- bryt linjen ved null
            borderWidth: 2,
            fill: false
          },
          {
            label: 'Jordtemperatur (°C)',
            data: dense,
            parsing: { xAxisKey: 'timestamp', yAxisKey: 'soil_temperature' },
            spanGaps: false,
            borderWidth: 2,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: xScaleTime },
        plugins: commonPlugins
      }
    });

    // 4) Fuktighet (to y-akser + hull i data)
    new Chart(document.getElementById('humidityChart'), {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'Luftfuktighet (%)',
            data: dense,
            parsing: { xAxisKey: 'timestamp', yAxisKey: 'air_humidity' },
            yAxisID: 'y1',
            spanGaps: false,
            borderWidth: 2,
            fill: false
          },
          {
            label: 'Jordfuktighet (%)',
            data: dense,
            parsing: { xAxisKey: 'timestamp', yAxisKey: 'soil_moisture' },
            yAxisID: 'y',
            spanGaps: false,
            borderWidth: 2,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        scales: {
          x: xScaleTime,
          y:  {
            type: 'linear',
            display: true,
            position: 'left',
            ticks: { callback: (v) => v + '%' }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: { callback: (v) => v + '%' }
          }
        },
        plugins: commonPlugins
      }
    });
  </script>
{% endif %}
{% endblock %}