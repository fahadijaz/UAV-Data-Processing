{% extends "mainapp/base.html" %}
{% block title %}Last opp sensor-data{% endblock %}

{% block content %}
  <div class="max-w-5xl mx-auto p-6 shadow-md rounded-lg space-y-6" style="background-color: #e8ece4;">
    <h2 class="text-2xl font-semibold text-gray-800">Last opp sensor-data (JSON)</h2>

    {% if messages %}
      <div>
        {% for message in messages %}
          <p class="text-sm text-{{ message.tags }}">{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Upload form (POST) -->
    <form method="post" enctype="multipart/form-data" class="space-y-4">
      {% csrf_token %}
      <label for="files" class="block text-sm font-medium text-gray-700">Velg JSON-filer:</label>
      <input type="file" name="files" id="files" multiple class="block w-full">
      <button type="submit"
              class="text-white px-4 py-2 rounded transition"
              style="background-color:#408424;"
              onmouseover="this.style.backgroundColor='#36711f'"
              onmouseout="this.style.backgroundColor:'#408424'">
        Last opp
      </button>
    </form>

    <!-- Filter form (GET) -->
    <form method="get" class="space-y-4">
      <label for="sensor" class="block text-sm font-medium text-gray-700">Velg sensor:</label>
      <select name="sensor" id="sensor" class="w-full border border-gray-300 rounded p-2">
        {% for sensor in sensors %}
          <option value="{{ sensor.sensor_id }}" {% if request.GET.sensor == sensor.sensor_id %}selected{% endif %}>
            {{ sensor.sensor_id }}
          </option>
        {% endfor %}
      </select>

      <div class="flex space-x-4">
        <div class="w-1/2">
          <label for="start_date" class="block text-sm font-medium text-gray-700">Startdato:</label>
          <input type="date"
                 name="start_date" id="start_date"
                 value="{{ request.GET.start_date|default:default_start }}"
                 class="w-full border border-gray-300 rounded p-2">
        </div>
        <div class="w-1/2">
          <label for="end_date" class="block text-sm font-medium text-gray-700">Sluttdato:</label>
          <input type="date"
                 name="end_date" id="end_date"
                 value="{{ request.GET.end_date|default:default_end }}"
                 class="w-full border border-gray-300 rounded p-2">
        </div>
      </div>

      <button type="submit"
              class="w-full text-white py-2 px-4 rounded transition"
              style="background-color:#408424;"
              onmouseover="this.style.backgroundColor='#36711f'"
              onmouseout="this.style.backgroundColor='#408424'">
        Vis data
      </button>
    </form>

    {% if latest_readings %}
      <div>
        <p class="text-lg font-semibold">
          Siste batterinivå: <span class="text-blue-700">{{ latest_readings.battery }} V</span>
        </p>
      </div>
    {% endif %}

    <div id="chart-container" class="space-y-6 mt-6">
      <div class="w-full h-[400px]"><canvas id="tempChart"></canvas></div>
      <div class="w-full h-[400px]"><canvas id="humidityChart"></canvas></div>
    </div>
  </div>

  <script id="chart-data" type="application/json">{{ chart_data_json|default:"[]"|safe }}</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

<script>
  const GAP_MS =  60 * 60 * 1000; 

  const raw = JSON.parse(document.getElementById('chart-data').textContent || '[]');

  const parseUTC = (s) => {
    if (!s) return null;
    let iso = s.includes('T') ? s : s.replace(' ', 'T');
    if (iso.length === 16) iso += ':00';  
    if (!iso.endsWith('Z')) iso += 'Z';  
    const d = new Date(iso);
    return isNaN(+d) ? null : d;
  };
  const toNum = v => (v === null || v === undefined || v === '' ? null : Number(v));
  const byX = (a, b) => a.x - b.x;

  const toPoints = (key) =>
    raw.map(r => {
      const x = parseUTC(r.timestamp);
      const y = toNum(r[key]);
      return (x && Number.isFinite(y)) ? { x, y } : null;
    }).filter(Boolean).sort(byX);

  const airTempPoints   = toPoints('air_temperature');
  const soilTempPoints  = toPoints('soil_temperature');
  const airHumPoints    = toPoints('air_humidity');
  const soilMoistPoints = toPoints('soil_moisture');

  const xScaleTime = {
    type: 'time',
    time: {
      tooltipFormat: 'dd.MM.yyyy HH:mm',
      displayFormats: { hour: 'dd.MM HH:mm', day: 'dd.MM' }
    },
    min: "{{ default_start }}T00:00:00Z",
    max: "{{ default_end }}T23:59:59Z"
  };

  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'nearest', intersect: false },
    plugins: {
      legend: { position: 'bottom' },
      tooltip: { mode: 'nearest', intersect: false },
      decimation: { enabled: false } 
    },
    elements: {
      point: { radius: 2 },
      line:  { tension: 0 }
    },
    scales: { x: xScaleTime }
  };

  const makeSegmentGapHider = () => ({
    borderColor: ctx => {
      const p0 = ctx.p0?.parsed?.x, p1 = ctx.p1?.parsed?.x;
      if (p0 == null || p1 == null) return undefined;
      return (p1 - p0) > GAP_MS ? 'rgba(0,0,0,0)' : undefined;
    }
  });

  new Chart(document.getElementById('tempChart'), {
    type: 'line',
    data: {
      datasets: [
        {
          label: 'Lufttemperatur (°C)',
          data: airTempPoints,
          borderWidth: 2,
          fill: false,
          segment: makeSegmentGapHider(),
          normalized: true
        },
        {
          label: 'Jordtemperatur (°C)',
          data: soilTempPoints,
          borderWidth: 2,
          fill: false,
          segment: makeSegmentGapHider(),
          normalized: true
        }
      ]
    },
    options: commonOptions
  });

  new Chart(document.getElementById('humidityChart'), {
    type: 'line',
    data: {
      datasets: [
        {
          label: 'Luftfuktighet (%)',
          data: airHumPoints,
          yAxisID: 'y1',
          borderWidth: 2,
          fill: false,
          segment: makeSegmentGapHider(),
          normalized: true
        },
        {
          label: 'Jordfuktighet (%)',
          data: soilMoistPoints,
          yAxisID: 'y',
          borderWidth: 2,
          fill: false,
          segment: makeSegmentGapHider(),
          normalized: true
        }
      ]
    },
    options: {
      ...commonOptions,
      scales: {
        x: xScaleTime,
        y:  {
          type: 'linear',
          position: 'left',
          ticks: { callback: v => v + '%' }
        },
        y1: {
          type: 'linear',
          position: 'right',
          grid: { drawOnChartArea: false },
          ticks: { callback: v => v + '%' }
        }
      }
    }
  });

  console.info('Antall punkter:', {
    luftTemp: airTempPoints.length,
    jordTemp: soilTempPoints.length,
    luftFukt: airHumPoints.length,
    jordFukt: soilMoistPoints.length
  });
</script>
{% endblock %}
