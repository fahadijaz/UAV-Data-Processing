{# templates/mainapp/sd_card.html #}
{% extends "mainapp/base.html" %}
{% load widget_tweaks %}

{% block title %}Upload Flights{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4">
  <form method="post" enctype="multipart/form-data" class="space-y-8">
    {% csrf_token %}
    {{ formset.management_form }}

    {% for form in formset %}
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <!-- header -->
        <div class="bg-nmbu-green px-6 py-4 flex justify-between items-center">
          <h2 class="text-xl font-semibold text-white truncate">
            {{ form.flight_dir.value|cut:"/Volumes/SD_Card/DCIM/" }}
          </h2>
          <span class="bg-nmbu-dark text-white text-sm font-medium px-3 py-1 rounded">
            Flight {{ forloop.counter }}
          </span>
        </div>
        <!-- body -->
        <div class="px-6 py-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
          {{ form.flight_path_key }}{{ form.flight_dir }}

          <div>
            {{ form.pilot.label_tag|add_class:"block text-sm font-medium text-nmbu-green" }}
            {{ form.pilot|add_class:"mt-1 block w-full border-gray-300 rounded-md p-2 focus:ring-nmbu-green focus:border-nmbu-green shadow-sm" }}
            {{ form.pilot.errors }}
          </div>

          <div>
            {{ form.drone_model.label_tag|add_class:"block text-sm font-medium text-nmbu-green" }}
            {{ form.drone_model|add_class:"mt-1 block w-full border-gray-300 rounded-md p-2 focus:ring-nmbu-green focus:border-nmbu-green shadow-sm bg-white" }}
            {{ form.drone_model.errors }}
          </div>

          <div class="lg:col-span-2">
            <label class="block text-sm font-medium text-nmbu-green">Wind speed (m/s)</label>
            <div class="flex space-x-3 mt-1">
              {{ form.wind_speed1|add_class:"w-1/3 border-gray-300 rounded-md p-2 focus:ring-nmbu-green focus:border-nmbu-green shadow-sm" }}
              {{ form.wind_speed2|add_class:"w-1/3 border-gray-300 rounded-md p-2 focus:ring-nmbu-green focus:border-nmbu-green shadow-sm" }}
              {{ form.wind_speed3|add_class:"w-1/3 border-gray-300 rounded-md p-2 focus:ring-nmbu-green focus:border-nmbu-green shadow-sm" }}
            </div>
            {{ form.wind_speed1.errors }}{{ form.wind_speed2.errors }}{{ form.wind_speed3.errors }}
          </div>

          <div class="lg:col-span-2">
            {{ form.comments.label_tag|add_class:"block text-sm font-medium text-nmbu-green" }}
            {{ form.comments|add_class:"mt-1 block w-full border-gray-300 rounded-md p-2 h-24 resize-none focus:ring-nmbu-green focus:border-nmbu-green shadow-sm" }}
            {{ form.comments.errors }}
          </div>

          <div class="lg:col-span-2 flex space-x-6 items-start mt-4">
            <div class="flex-1">
              {{ form.skyline_files.label_tag|add_class:"block text-sm font-medium text-nmbu-green" }}
              {{ form.skyline_files
                 | add_class:"mt-1 block w-full file:border file:border-gray-300 file:rounded-md file:px-3 file:py-2 file:bg-nmbu-green file:text-white hover:file:bg-nmbu-dark focus:ring-nmbu-green focus:border-nmbu-green shadow-sm"
                 | attr:"multiple"
                 | attr:"accept=image/jpeg"
              }}
              {{ form.skyline_files.errors }}
              <p class="mt-1 text-xs text-gray-500"><span class="skyline-count font-medium">0</span> selected</p>
              {{ form.skyline_names }}
            </div>
            <div class="flex-1">
              {{ form.reflectance_dir.label_tag|add_class:"block text-sm font-medium text-nmbu-green" }}
              {{ form.reflectance_dir|add_class:"mt-1 block w-full file:border file:border-gray-300 file:rounded-md file:px-3 file:py-2 hover:file:bg-gray-50 focus:ring-nmbu-green focus:border-nmbu-green shadow-sm" }}
              {{ form.reflectance_dir.errors }}
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-center text-gray-500">No flights detected on that card.</p>
    {% endfor %}

    <div class="flex justify-end">
      <button name="upload" type="submit"
              class="px-6 py-3 bg-nmbu-green text-white rounded-lg hover:bg-nmbu-dark transition">
        Upload All
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("input[type=file][multiple]").forEach(input => {
      const c = input.closest("div").querySelector(".skyline-count");
      input.addEventListener("change", () => {
        c.textContent = input.files.length;
      });
    });
  });
</script>
{% endblock %}
