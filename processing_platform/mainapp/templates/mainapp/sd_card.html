{% extends "mainapp/base.html" %}

{% block title %}Upload Flights{% endblock %}

{% block content %}
<div class="flex max-w-6xl mx-auto px-6 space-x-8">
 <div class="flex-1">
   <form
     id="flight-upload-form"
     method="post"
     enctype="multipart/form-data"
     class="space-y-8"
   >
     {% csrf_token %}

     <div>
       <label for="sd_card" class="block text-sm font-semibold text-dark-green">
         Select SD Card
       </label>
       <select
         name="sd_card"
         id="sd_card"
         class="mt-1 block w-full border-2 border-normal-green rounded-lg p-2 focus:ring-2 focus:ring-dark-green shadow-sm"
         onchange="loadFlights()"
       >
         <option value="">-- Select SD Card --</option>
         {% for card in sd_cards %}
           <option value="{{ card }}" {% if card == selected_dcim %}selected{% endif %}>
             {{ card|cut:'/Volumes/' }}
           </option>
         {% endfor %}
       </select>
     </div>

     {% if formset %}
       <input type="hidden" name="selected_dcim" value="{{ selected_dcim }}">
       {{ formset.non_form_errors }}
       {% if formset.management_form.errors %}
         <ul class="text-red-600 list-disc pl-5">
           {% for field, errors in formset.management_form.errors.items %}
             {% for error in errors %}
               <li>{{ field }}: {{ error }}</li>
             {% endfor %}
           {% endfor %}
         </ul>
       {% endif %}
       {{ formset.management_form }}

       {% for form in formset %}
         {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

         <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
           <div class="px-2 py-1 bg-gray-100">
             <small class="text-gray-600">Folder: {{ form.folder_name.value }}</small>
           </div>

           <div class="px-6 py-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
             <div>
               <label for="{{ form.pilot.id_for_label }}" class="block text-sm font-semibold text-dark-green mb-1">Pilot</label>
               <select name="{{ form.pilot.html_name }}" id="{{ form.pilot.id_for_label }}"
                       class="mt-1 block w-full border-2 border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-dark-green shadow-sm">
                 {% for value, label in pilot_choices %}
                   <option value="{{ value }}" {% if form.pilot.value == value %}selected{% endif %}>{{ label }}</option>
                 {% endfor %}
               </select>
               {{ form.pilot.errors }}
             </div>
             <div>
               <label for="{{ form.drone_model.id_for_label }}" class="block text-sm font-semibold text-dark-green mb-1">Drone model</label>
               <select name="{{ form.drone_model.html_name }}" id="{{ form.drone_model.id_for_label }}"
                       class="mt-1 block w-full border-2 border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-dark-green shadow-sm">
                 {% for value, label in drone_model_choices %}
                   <option value="{{ value }}" {% if form.drone_model.value == value %}selected{% endif %}>{{ label }}</option>
                 {% endfor %}
               </select>
               {{ form.drone_model.errors }}
             </div>
             <div class="lg:col-span-2">
               <label class="block text-sm font-semibold text-dark-green mb-1">
                 Wind speed (m/s)
               </label>
               <div class="flex space-x-4 mt-1">
                 <input type="number" name="{{ form.prefix }}-wind_speed1" 
                        class="block w-full border-2 border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-dark-green shadow-sm"
                        min="0" max="50" step="0.1" placeholder="Start" value="{{ form.wind_speed1.value|default:'' }}">
                 <input type="number" name="{{ form.prefix }}-wind_speed2" 
                        class="block w-full border-2 border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-dark-green shadow-sm"
                        min="0" max="50" step="0.1" placeholder="Mid" value="{{ form.wind_speed2.value|default:'' }}">
                 <input type="number" name="{{ form.prefix }}-wind_speed3" 
                        class="block w-full border-2 border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-dark-green shadow-sm"
                        min="0" max="50" step="0.1" placeholder="End" value="{{ form.wind_speed3.value|default:'' }}">
               </div>
             </div>
             <div class="lg:col-span-2">
               <label for="{{ form.comments.id_for_label }}" class="block text-sm font-semibold text-dark-green mb-1">Comments</label>
               <textarea name="{{ form.comments.html_name }}" id="{{ form.comments.id_for_label }}" rows="2"
                         class="mt-1 block w-full border-2 border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-dark-green shadow-sm"
                         placeholder="Flight comments">{{ form.comments.value|default:'' }}</textarea>
               {{ form.comments.errors }}
             </div>

             <div class="lg:col-span-2">
               <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div>
                   <label class="block text-sm font-semibold text-dark-green mb-1">
                     Skyline files
                   </label>
                   <div class="flex border border-gray-300 rounded-lg overflow-hidden">
                     <label
                       for="skyline_{{ form.prefix }}"
                       class="px-4 py-2 bg-normal-green text-black cursor-pointer hover:bg-dark-green transition-colors"
                     >
                       Browse…
                       <input
                         id="skyline_{{ form.prefix }}"
                         name="{{ form.prefix }}-skyline_files"
                         type="file"
                         multiple
                         accept="image/*,.jpg,.jpeg,.png,.tif,.tiff"
                         class="hidden"
                         onchange="updateSkylineFiles(this, '{{ form.prefix }}')"
                       >
                     </label>
                     <div
                       id="skyline_display_{{ form.prefix }}"
                       class="flex-1 px-4 py-2 bg-white flex items-center text-gray-700"
                     >
                       None selected
                     </div>
                   </div>
                   <input type="hidden" name="{{ form.prefix }}-skyline_names" id="skyline_names_{{ form.prefix }}" value="{{ form.skyline_names.value|default:'' }}">
                 </div>

                 <div>
                   <label class="block text-sm font-semibold text-dark-green mb-1">
                     Reflectance panel folder
                   </label>
                   <div class="flex border border-gray-300 rounded-lg overflow-hidden">
                     <label
                       for="reflectance_{{ form.prefix }}"
                       class="px-4 py-2 bg-normal-green text-black cursor-pointer hover:bg-dark-green transition-colors"
                     >
                       Browse…
                       <input
                         id="reflectance_{{ form.prefix }}"
                         name="{{ form.prefix }}-reflectance_files"
                         type="file"
                         webkitdirectory
                         class="hidden"
                         onchange="updateReflectanceFolder(this, '{{ form.prefix }}')"
                       >
                     </label>
                     <div
                       id="reflectance_display_{{ form.prefix }}"
                       class="flex-1 px-4 py-2 bg-white flex items-center text-gray-700"
                     >
                       None selected
                     </div>
                   </div>
                   <input type="hidden" name="{{ form.prefix }}-reflectance_dir" id="reflectance_dir_{{ form.prefix }}" value="{{ form.reflectance_dir.value|default:'' }}">
                 </div>
               </div>
             </div>
           </div>
         </div>
       {% empty %}
         <p class="text-center text-gray-500">No flights detected on that card.</p>
       {% endfor %}

       <div class="flex justify-end">
         <button
           id="upload-btn"
           name="upload"
           type="submit"
           class="relative inline-flex items-center px-8 py-3 bg-green-700 text-black font-semibold rounded-xl hover:bg-green-500 transition-colors"
           onclick="showLoadingOverlay()"
         >
           <svg
             id="upload-spinner"
             class="absolute left-4 top-1/2 -mt-2 h-5 w-5 text-white hidden animate-spin"
             xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
           >
             <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
             <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/>
           </svg>
           <span id="btn-text">Upload All</span>
         </button>
       </div>
     {% else %}
       {% if selected_dcim %}
         <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
           <h3 class="text-lg font-semibold text-blue-800 mb-2">No flights detected on that card.</h3>
           <p class="text-blue-700">Make sure the SD card contains flight folders with the expected naming pattern.</p>
         </div>
       {% else %}
         <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
           <h3 class="text-lg font-semibold text-gray-800 mb-2">Select an SD card to view available flights.</h3>
         </div>
       {% endif %}
     {% endif %}
   </form>
 </div>
</div>

<div
 id="loading-overlay"
 class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50"
>
 <div class="bg-white p-8 rounded-2xl flex items-center space-x-4 shadow-lg">
   <svg
     id="upload-spinner-overlay"
     class="h-8 w-8 text-normal-green animate-spin"
     xmlns="http://www.w3.org/2000/svg"
     fill="none"
     viewBox="0 0 24 24"
   >
     <circle
       class="opacity-25"
       cx="12"
       cy="12"
       r="10"
       stroke="currentColor"
       stroke-width="4"
     />
     <path
       class="opacity-75"
       fill="currentColor"
       d="M4 12a8 8 0 018-8v8z"
     />
   </svg>
   <span class="text-lg font-medium text-dark-green">Uploading…</span>
 </div>
</div>

<script>
function loadFlights() {
  const select = document.getElementById('sd_card');
  const selectedDcim = select.value;
  if (selectedDcim) {
    window.location.href = `?selected_dcim=${encodeURIComponent(selectedDcim)}`;
  } else {
    window.location.href = window.location.pathname;
  }
}

function updateSkylineFiles(input, prefix) {
  const display = document.getElementById(`skyline_display_${prefix}`);
  const hiddenField = document.getElementById(`skyline_names_${prefix}`);
  const files = Array.from(input.files);
  
  if (files.length > 0) {
    const fileNames = files.map(file => file.name).join(', ');
    display.textContent = files.length === 1 ? files[0].name : `${files.length} files selected`;
    display.classList.add('text-green-700');
    display.classList.remove('text-gray-700');
    hiddenField.value = fileNames;
  } else {
    display.textContent = 'None selected';
    display.classList.add('text-gray-700');
    display.classList.remove('text-green-700');
    hiddenField.value = '';
  }
}

function updateReflectanceFolder(input, prefix) {
  const display = document.getElementById(`reflectance_display_${prefix}`);
  const hiddenField = document.getElementById(`reflectance_dir_${prefix}`);
  const files = Array.from(input.files);
  
  if (files.length > 0) {
    const firstFile = files[0];
    const pathParts = firstFile.webkitRelativePath.split('/');
    const folderName = pathParts[0];
    const selectedDcim = document.querySelector('input[name="selected_dcim"]').value;
    const fullPath = `${selectedDcim}/${folderName}`;
    display.textContent = `${folderName} (${files.length} files)`;
    display.classList.add('text-green-700');
    display.classList.remove('text-gray-700');
    hiddenField.value = fullPath;
  } else {
    display.textContent = 'None selected';
    display.classList.add('text-gray-700');
    display.classList.remove('text-green-700');
    hiddenField.value = '';
  }
}

function showLoadingOverlay() {
  document.getElementById('loading-overlay').classList.remove('hidden');
  document.getElementById('upload-spinner').classList.remove('hidden');
  document.getElementById('btn-text').textContent = 'Uploading...';
}
</script>

{% endblock %}